<?php

/**
 * Implements hook_menu().
 */
function th_main_menu_menu() {
  $items = array();

  $items['ask-a-question'] = array(
    'title' => 'Ask a question',
    'page callback' => 'th_main_menu_aaq_callback',
    'access arguments' => array('access content'),
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

function th_main_menu_aaq_callback(){
  if(user_access('create question content')){

    return drupal_goto('node/add/question');
  }
  else{
    $login = url('user', array('query' => array('destination' => 'node/add/question')));
    $register = url('user/register', array('query' => array('destination' => 'node/add/question')));
    return t('<a href="@login">Log in</a>/ <a href="@register">register</a> to post a question', array('@login' => $login, '@register' => $register));
  }
}

function th_main_menu_block_info() {
  $blocks['th_main_menu'] = array(
    'info' => 'Town hall: Main menu',
    'cache' => DRUPAL_NO_CACHE,
    'status' => 1,
  );

  return $blocks;
}

function th_main_menu_block_view($delta = '') {
	global $user;
  if ($delta == 'th_main_menu') {
    $candidates_output = views_embed_view('candidates', 'block_1');
    $parteis_output = views_embed_view('parties', 'block_1');


    if (!preg_match('/select/', $candidates_output)) {
      $form = array(
        '#type' => 'select',
        '#options' => array('0'=> t('Candidates')),
        '#attributes' => array(
          'disabled' => 'true',
          'class' => array('ctools-jump-menu-select'),
        ),
      );
      $candidates_output = drupal_render($form);
    }

    if (!preg_match('/select/', $parteis_output)) {
      $form = array(
        '#type' => 'select',
        '#options' => array('0'=> t('Parties')),
        '#attributes' => array(
          'disabled' => 'true',
          'class' => array('ctools-jump-menu-select'),
        ),
      );
      $parteis_output = drupal_render($form);
    }

    $output = '<ul>';

    $output .= '<li>' . l(t('Issues'), 'questions') . '</li>';
    $output .= '<li>' . $candidates_output . '</li>';
    $output .= '<li>' . $parteis_output . '</li>';
    $output .= '<li>' . l(t('Ask a question'), 'ask-a-question') . '</li>';
    $output .= '<li>' . l(t('About'), url('content/about', array('absolute' => true))) . '</li>';

    $output .= '</ul>';

    $block['content'] = array('#markup' => $output);

    return $block;
  }
}
